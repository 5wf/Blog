---
layout: post
title: "HowTo: SQL Server Compact Edition mit LINQ to SQL verwenden"
date: 2008-02-28 00:16
author: robert.muehsig
comments: true
categories: [HowTo]
tags: [.NET 3.5, HowTo, LINQ, LINQ to SQL, O/R Mapper, O\R Mapping, SQL Server, SQL Server Compact Edition]
---
{% include JB/setup %}
<p>Auf der <a href="http://www.vsone.de/">VSone</a> habe ich das erste mal von den <a href="http://www.microsoft.com/sql/editions/compact/default.mspx">SQL Server in der Compact Edition</a> (Version 3.5 ist momentan aktuell) gehört. In dem <a href="{{BASE_PATH}}/2008/02/17/vsone-tag-2-wcf-sql-server-compact-edition-systemaddin-adonet-entity-framework-adonet-data-services-astoria/">dazugehörigen Blogeintrag</a> habe ich bereits einige der wichtigsten Angaben zu dem SQL Server Compact Edition geschrieben.</p>  <p><strong>Kurzzusammenfassung:</strong></p>  <p>- SQL DB für bis zu 4 GB Daten    <br />- Bekannte Tools nutzbar     <br />- Benötigt keine Installation etc.     <br />- Relationen sind einstellbar</p>  <p><strong>Kleines Problem: Geht LINQ to SQL?</strong></p>  <p>Wer einmal mit LINQ to SQL gearbeitet hat, wird es sicherlich schick finden - jedenfalls schicker als das normale ADO.NET Thema. Wenn man das allerdings ausprobiert, bekommt man eine Fehlermeldung:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image291.png"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb270.png" width="323" height="133" /></a></p>  <p>Erstmal die Entwarnung: Es geht - mit einem kleinen Trick.</p>  <p><strong>Doch langsam: Vorbereitung</strong></p>  <p>Als erstes benötigen wir eine &quot;Local Database&quot;:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image292.png"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb271.png" width="437" height="177" /></a></p>  <p>Diese SQL Server Compact Edition Database erkennt man an der &quot;sdf&quot; Endung. <u>Nachdem wir dies gemacht haben, kommt so ein Dataset Dialog - den einfach ignorieren und schließen.</u>&#160;</p>  <p>Jetzt legen wir unsere Tabellen an - der Dialog ist ähnlich wie beim SQL Management Studio:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image293.png"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb272.png" width="362" height="293" /></a></p>  <p>Nachdem wir&#160; nun eine Company Tabelle (&quot;Id&quot; = Guid, &quot;Name&quot; = nvarchar) &amp; Employee (&quot;Id&quot; = Guid, &quot;Firstname&quot; = nvarchar, &quot;Lastname&quot; = nvarchar, &quot;CompanyId&quot; = Guid) können wir über ein Kontextmenü die Verknüpfung zwischen den beiden Tabellen einstellen:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image294.png"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb273.png" width="244" height="227" /></a></p>  <p>Das entsprechende Menü:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image295.png"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb274.png" width="449" height="364" /></a></p>  <p>Nachdem wir das haben, kommen wir nun zum eigentlichen Teil:</p>  <p><strong>LINQ to SQL einsetzen</strong></p>  <p>Bei einer normalen MDF oder einer SQL Server Tabelle kann man den Designer nehmen, allerdings ist dies momentan bei einer Compact Edition DB nicht möglich.</p>  <p>Allerdings gibt es ein kleines Tool namens &quot;<a href="http://msdn2.microsoft.com/de-de/library/bb386987.aspx">SQLMetal.exe</a>&quot;, welches normalerweise unter diesem Pfad zu finden ist:     <br />C:\Program Files\Microsoft SDKs\Windows\v6.0A\bin</p>  <p>Die Datei &quot;SQLMetal.exe&quot; sowie die Config Datei habe ich einfach mit in mein Projektverzeichnis kopiert.</p>  <p><strong>Danach wird es wie folgt aufgerufen:</strong>     <br />SqlMetal.exe Database.sdf /dbml:Enterprise.dbml /namespace:SQLCompact /pluralize</p>  <p>Folgendes passiert: Die Database.sdf wird aufgerufen und es wird eine Enterprise.dbml erstellt - im Namespace &quot;SQLCompact&quot;.</p>  <p><strong>DBML dem Projekt hinzufügen</strong></p>  <p>Damit man es im Projekt nutzen kann, muss man es noch einblenden:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image296.png"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb275.png" width="187" height="64" /></a></p>  <p>... und am Ende sieht man sowas:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image297.png"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb276.png" width="244" height="122" /></a></p>  <p>Müsste eigentlich bekannt vorkommen, oder? ;)</p>  <p><strong>Update aus den Kommentaren: Es wird keine designer.cs Datei angelegt</strong></p>  <p>Die Lösung wurde von David in diesen <a href="http://stackoverflow.com/questions/133515/autogeneration-of-a-datacontext-designer-file-when-using-sqlmetal-and-visual-stud">Stackoverflow Thread</a> gefunden. Um die Designer.cs auch erzeugen zu lassen muss man unter den Eigenschaften der DBML-Datei "MSLinqToSQLGenerator” in die Eigenschaft "Benutzerdefiniertes Tool”/”Custom Tool” eintragen. Vielen Dank an den Hinweis an David.</p>  <p><strong>Beispiel: Datensatz einfügen</strong></p>  <p>Der Datacontext kann entweder über die verschiedenen Parameter anders benannt werden oder ist im Standardfall gleich mit dem sdf Namen. Sodass wir nun mit dem Code eine neue Firma einfügen können:</p>  <p><a href="{{BASE_PATH}}/assets/wp-images/image298.png"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb277.png" width="634" height="93" /></a></p>  <p>Also alles nix neues - der Connectionstring kann vom Serverexplorer unter &quot;Eigenschaften&quot; ausgelesen werden oder von dieser <a href="http://www.connectionstrings.com/?carrier=sqlserver2005ce">Website</a>.</p>  <p>Jetzt können wir alles anwenden, was wir z.B. <a href="{{BASE_PATH}}/2008/01/21/howto-or-mapper-linq-to-sql-einfhrung-in-den-designer-1n-beziehungen/">hier</a> oder <a href="{{BASE_PATH}}/2008/01/21/howto-or-mapper-linq-to-sql-einfhrung-in-den-designer-1n-beziehungen/">hier</a> kennengelernt haben.</p>  <p>Hier gibts noch ein paar <a href="http://www.codeproject.com/KB/dotnet/Compact_LINQ.aspx#LINQ2SSCE">LINQ Informationen</a>.</p>  <p>Viel Spaß :)</p>  <p><strong><a href="http://{{BASE_PATH}}/assets/files/democode/sqlcompact/sqlcompact.zip">[Download Source Code]</a></strong></p>
