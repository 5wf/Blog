---
layout: post
title: "HowTo: Continuous Integration mit TeamCity"
date: 2009-07-14 21:37
author: robert.muehsig
comments: true
categories: [HowTo]
tags: [Build, Build Server, CI, Continuous Integration, HowTo, TeamCity]
---
<p><a href="{{BASE_PATH}}/assets/wp-images/image780.png"><img style="border-right: 0px; border-top: 0px; margin: 0px 10px 0px 0px; border-left: 0px; border-bottom: 0px" height="139" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb758.png" width="162" align="left" border="0"></a> In meinem letzten <a href="http://code-inside.de/blog/2009/07/08/howtocode-continuous-integration/">HowToCode ging es um "Continuous Integration"</a> und was es alles bieten könnte. Nun möchte ich ein konkretes Tool vorstellen: <a href="http://www.jetbrains.com/teamcity/">TeamCity</a>. TeamCity ist ein kostenloser (Java basierende) Buildmanagement &amp; Continuous Integration Server von JetBrains (welche auch den Resharper machen). Über eine schicke Weboberfläche ist das ganze auch schnell eingerichtet und man kann seine Builds usw. anstoßen.</p><!--more--> <p><strong>Was ist TeamCity?<br></strong>Wie bereits erwähnt, ist TeamCity im Grunde ein Java basierender Build- &amp; CI Server. Man kann TeamCity auf Window-, Linux etc. installieren. Ich stelle hier nur die Windows Variante vor.<br>Da JetBrain ständig das Produkt erneuert, verlinke ich nur auf die <a href="http://www.jetbrains.com/teamcity/documentation/index.html">Dokumentationsseite</a>.</p> <p>JetBrain hat auch eine Seite eingerichet wo man sich das Webfrontent mal anschauen kann: <a href="http://teamcity.jetbrains.com/guestLogin.html?guest=1"><strong>Live Demo</strong></a></p> <p><strong>Was sind die Voraussetzungen?<br></strong>Als Voraussetzung gilt natürlich, dass man einen Server hat (das kann auch derselbe Server sein wie das SVN z.B.) und das man alles was man zum Bauen braucht eingecheckt hat bzw. die Abhängigkeiten auch auf den Build Server installiert/hergestellt hat. Weitere Infos, warum das ein Build Server recht nützlich ist, siehe in meinem <a href="http://code-inside.de/blog/2009/07/08/howtocode-continuous-integration/">anderen Blogpost</a>.</p> <p><strong>"Bestandteile"<br></strong>Wenn man den <a href="http://www.jetbrains.com/teamcity/download/index.html#win">Standard-Windows Installationsassistent</a> folgt, wird der Build-Server und ein Build-Agent gleicht installiert. Beides kann getrennt konfiguriert werden. Dazu später mehr. Der Agent führt am Ende den Buildvorgang auf. Das kann für größere Projekte interessant sein, wenn man viele Projekte hat.<br>Jeder Agent kann andere Konfigurationen aufweisen, andere CPU Werte (für die Performance) und auf anderen Betriebsystemen etc. laufen.</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image781.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="327" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb759.png" width="404" border="0"></a> </p> <p>Diese findet man auch auf der <a href="http://teamcity.jetbrains.com/guestLogin.html?guest=1">Weboberfläche</a> wieder:</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image782.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="249" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb760.png" width="399" border="0"></a> </p> <p><strong>Installation</strong></p> <p>Hier eine kleine Schritt-für-Schritt Anleitung um den Server auf einer Windows Kiste zu installieren: <br>Die Screenshots habe ich <a href="http://sebastienlachance.com/2008/02/06/setting-up-a-basic-continuous-integration-server-with-teamcity/"><strong>von diesem Blog</strong></a> - da die Installation allerdings bei mir auch so aussah, habe ich die Bilderchens mal genommen.</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image783.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="340" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb761.png" width="442" border="0"></a> </p> <p><a href="{{BASE_PATH}}/assets/wp-images/image784.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="338" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb762.png" width="439" border="0"></a> </p> <p><a href="{{BASE_PATH}}/assets/wp-images/image785.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="341" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb763.png" width="443" border="0"></a> </p> <p><strong>Anmerkungen jetzt:</strong> Hier ist es sehr empfehlenswert den Server und Build Agent direkt als Windows Service zu installieren (was auch per default ausgewählt ist), ansonsten muss man ihn manuell starten.</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image786.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="352" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb764.png" width="458" border="0"></a> </p> <p><strong>Anmerkung:</strong> In meinem Fall lief auf Port 80 noch der IIS, daher musste ein anderer Port gewählt werden. Unter dem Punkt "Portänderungen" komm ich dann nochmal darauf zu sprechen.</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image787.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="359" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb765.png" width="467" border="0"></a> </p> <p><a href="{{BASE_PATH}}/assets/wp-images/image788.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="355" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb766.png" width="477" border="0"></a> </p> <p><a href="{{BASE_PATH}}/assets/wp-images/image789.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="370" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb767.png" width="497" border="0"></a> </p> <p><a href="{{BASE_PATH}}/assets/wp-images/image790.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="394" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb768.png" width="513" border="0"></a> </p> <p><a href="{{BASE_PATH}}/assets/wp-images/image791.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="402" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb769.png" width="523" border="0"></a> </p> <p>Nun kann der Rest über das Webfrontend konfiguiert werden:</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image792.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="412" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb770.png" width="528" border="0"></a> </p> <p>Bevor es losgeht muss erstmal ein Administatoraccount erstellt werden.</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image793.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="421" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb771.png" width="539" border="0"></a></p> <p>Nun kann auf der Oberfläche ein neues Projekt angelegt werden:</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image794.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="423" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb772.png" width="541" border="0"></a> </p> <p>Über den "Create project" Link legt man ein neues Projekt an.</p> <p>Der Ablauf beinhaltet 8 Schritte:</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image795.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="343" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb773.png" width="190" border="0"></a> </p> <p><strong>1.</strong> Name &amp; Beschreibung<br><strong>2.</strong> Zugang zum Subversion etc. <br>TeamCity ist sehr flexibel und unterstützt momentan diese Versionskontrollsystem:</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image796.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="155" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb774.png" width="355" border="0"></a> </p> <p><strong>3.</strong> Build Runner <br>TeamCity unterstützt neben .NET auch noch andere Frameworks/Sprachen. So kann man bei den Build Runnern momentan aus diesen auswählen:</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image797.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="253" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb775.png" width="347" border="0"></a> </p> <p>Bei der Einstellung "sln2008" kann man sein normales VS Solutionfile angeben. Dabei muss man beim "Solution file path" den Pfad (ausgehend vom SVN Repository) und die sln Datei angeben.</p> <p>Die anderen Punkte ermöglichen tiefere Konfigurationen und Einstellungen. So kann man z.B. sagen, wann gebaut werden soll (Nachts) oder nach jedem Checkin etc.</p> <p><strong>Weitere prima Anleitungen:</strong></p> <ul> <li> <h4><a href="http://dotnetslackers.com/articles/net/Setting-up-a-build-environment.aspx">Setting up a build environment</a></h4></li> <li> <h3><a href="http://www.dimecasts.net/Content/WatchEpisode/46">Screencast #46 - Setting up Continuous Integration for your Application with Team City</a></h3></li></ul> <h3>Run Builds </h3> <p>Über den "Run..." Button kann man neue Builds anstoßen. Dabei wird zuerst geschaut, ob neue Sourcen im Repository liegen und falls ja, wird dies runtergeladen und dann wird der entsprechende Buildrunner angestoßen.</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image798.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="80" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb776.png" width="238" border="0"></a> </p> <p>Wenn alles geklappt hat, sollte man sowas sehen:</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image799.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="25" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb777.png" width="97" border="0"></a>&nbsp;</p> <p><strong>Live Demo</strong></p> <p>Ich empfehle euch mal einen Blick auf die <a href="http://teamcity.jetbrains.com/overview.html">Live Demo Page</a> zu werfen und ein wenig drin rumklicken. Auf der Weboberfläche werden mit vielen AJAX Spielerein sinnvolle Informationen nachgeladen, so z.B. Kommentare aus den letzten Checkin:</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image800.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="371" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb778.png" width="399" border="0"></a> </p> <p>Oder auch die dazugehörigen Files:</p> <p><a href="{{BASE_PATH}}/assets/wp-images/image801.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="247" alt="image" src="{{BASE_PATH}}/assets/wp-images/image-thumb779.png" width="390" border="0"></a> </p> <p><strong>TeamCity - benötigte Windows Services &amp; Portänderungen</strong></p> <p>TeamCity liefert zwar den Tomcat mit aus, allerdings sollte der Service ausgeschaltet bleiben bzw. ging es nur so bei mir. Es kann aber auch sein, dass der Tomcat durch etwas anderes evtl. installiert wurde. Diesen auf alle Fälle dekativieren.</p> <p><strong>Windows Services:</strong></p> <p>- Tomcat: deaktiviert<br> -TeamCity Build Agent Service: aktiviert<br> - TeamCity Web Server: aktiviert</p> <p>Server &amp; Buildagent lassen sich auch für andere Port konfigurieren. </p> <p>Ich hatte bei mir folgendes Problem, dass auch dem selben Rechner auch noch ein IIS läuft. </p> <p><strong>Portkonfiguration:</strong></p> <p>Webserver Config: "<em>C:\TeamCity\conf\server.xml</em>" dort diese Zeile suchen und Wert entsprechend ändern:</p> <div class="wlWriterSmartContent" id="scid:812469c5-0cb0-4c63-8c15-c81123a09de7:0288fc88-e662-4c48-8c17-4314f2c9fd26" style="padding-right: 0px; display: inline; padding-left: 0px; float: none; padding-bottom: 0px; margin: 0px; padding-top: 0px"><pre name="code" class="c#">   &lt;Connector  port="8xxx"  protocol="HTTP/1.1" 
               connectionTimeout="20000" 
               redirectPort="8443" /&gt;</pre></div>
<p>Nun müssen ebenfalls noch alle Build Agents entsprechend geändert werden. Dazu in dieser Datei:</p>
<p> "<em>C:\TeamCity\buildAgent\conf\buildAgent.dist.properties</em>" die serverUrl entsprechend mit den neuen Port anpassen.</p>
<p><strong>Troubleshooting</strong></p>
<p>Bei Fehlern lohnt sich immer ein Blick in den "logs" Ordner beim Server/Build Agent. Dort ist es recht detailiert beschrieben, was passiert und wo es knallt.</p>
<p><strong>Unit Tests, Deployment etc.</strong></p>
<p>Wir sind nun an dem Punkt an dem TeamCity installiert und benutzbar ist und das Projekt baut. Wie man Unit Tests oder gar ein Deployment ausführt werde ich in späteren HowTos behandeln.</p>
<p><strong>Fazit:</strong></p>
<p>TeamCity ist IMHO ein absolut geniales Tool und kann es locker mit dem Build Server vom TFS aufnehmen und die schicke Weboberfläche begeistert mit vielen netten Features und das ganze für Lau.</p>
